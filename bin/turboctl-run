#!/usr/bin/env python3

import os
import sys
import argparse

# Add the path to turboctl:
dirname = os.path.abspath(os.path.dirname(__file__))
superdir = os.path.split(dirname)[0]
if not superdir in sys.path:
    sys.path.append(superdir)
    
import turboctl, test_turboctl

parser = argparse.ArgumentParser(description='run turboctl')

mode_group = parser.add_mutually_exclusive_group()
mode_group.add_argument('-t', '--test', help='run tests', action='store_true')
mode_group.add_argument('-i', '--interactive', help='run in interactive mode',
                    action='store_true')

vpump_group = parser.add_mutually_exclusive_group()
vpump_group.add_argument('-v', '--virtual', help='use a virtual pump',
                         action='store_true')
vpump_group.add_argument('-p', '--port', 
                         help='the address of the serial port device')

parser.add_argument('command', help='the command to be run', nargs='*')

args = parser.parse_args()

if args.test:
    test_turboctl.run_tests()
    exit()

if args.interactive:
    UI = turboctl.InteractiveTUI
    ui_args = []
else:
    UI = turboctl.ShellTUI
    ui_args = [' '.join(args.command)]

if args.virtual:
    with turboctl.VirtualPump() as vp:
        ui = UI(vp.port)
        ui.run(*ui_args)
else:
    ui = UI(args.port)
    ui.run(*ui_args)